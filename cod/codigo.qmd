---
title: "proyecto_valoracion"
format: html
editor: visual
---

# Cargar librer铆as

```{r}
library(tidyverse)
library(readr)
library(readxl)
library(fitdistrplus)
library(scales)
library(dplyr)
library(MASS)
```

# Funciones

## Precios forward

Se utiliza para calcular el precio forward $P_f(t; S, T)$, asumiendo que $t=0$

```{r}
# Funci贸n para calcular el precio forward dada la informaci贸n actual 
precios.forward <- function(S, T, curva){
  
  # se asume solo informaci贸n actual (t=0)
  
  # ceiling(S * 100) / 100 se utiliza para redondear hacia arriba
  data.S <- curva %>% filter(curva$vencimiento == ceiling(S * 100) / 100)
  data.T <- curva %>% filter(curva$vencimiento == ceiling(T * 100) / 100)
  
  precio.S <- data.S$precio
  precio.T <- data.T$precio
  precio.forward <- precio.T / precio.S
  
  return(precio.forward)
}
```

## rbol de tasa corta

```{r}
# Funci贸n para generar trayectorias del 谩rbol de tasa corta
modelo.ho.lee <- function(u2, d2, curva, cant.periodos, trayectoria.tasa.corta){
  
  # proporci贸n de bajada respecto a la proporci贸n de subida
  k <- d2 / u2
  
  # log proporci贸n
  
  logk <- log(k)
  
  # probabilidad de subida en el 谩rbol de tasa corta
  q <- (1 - d2) / (u2 - d2)
  
  # valores iniciales
  
  # tasa corta actual (t=0, S=0, T=1/12)
  r0 <- -log(precios.forward(0, 1/12, curva))
  
  # cantidad de veces de subida
  Ut <- 0
  
  # vectores para guardar los resultados de la trayectoria
  rt.vec <- numeric(cant.periodos + 1)
  Ut.vec <- numeric(cant.periodos + 1)
  
  # valor inicial del dataframe en periodo  = 0
  rt.vec[1] <- r0
  Ut.vec[1] <- Ut
  
  for(i in 1:cant.periodos){
    
    # ver si la trayectoria subi贸 o baj贸
    if(trayectoria.tasa.corta[i] == 1){
      Ut <- Ut + 1
    }
    
    # dado que se valoriza mensualmente
    S <- 1/12 * i
    
    # calcular la proporci贸n de bajada
    dt1 <- k^i / ((1 - q) * k^i + q)
    
    # calcular la tasa corta en tiempo = i 
    rt <- -log(precios.forward(S, S + 1/12, curva)) - log(dt1) + Ut * logk
    
    rt.vec[i + 1] <- rt
    Ut.vec[i + 1] <- Ut
  }
  
  return(data.frame(periodo = 0:cant.periodos,
                          rt = rt.vec,
                          trayectoria = c(0, trayectoria.tasa.corta), 
                          Ut = Ut.vec))
}
```

## Dinamica de mercado

```{r}
prob.subida <- function(u, d, rt){
  # se verifican condiciones de no arbitraje
  if(u < exp(rt)){
    # tome rt = log(u)
    prob.subida <- (exp(log(u)) - d) / (u - d)
  } 
  
  if(d > exp(rt)){
    # tome rt = log(d)
    prob.subida <- (exp(log(d)) - d) / (u - d)
  } 
  
  else{
    # definici贸n cunado se cumplen las condiciones de arbitraje
    prob.subida <- (exp(rt) - d) / (u - d) 
  }
  
  return(prob.subida)
}
```


```{r}
mercado.acciones <- function(u2, d2, u, d, curva, cant.periodos, valor.accion, tasa.corta){
  
  # valores fijos del 谩rbol de tasa corta
  
  ## proporci贸n de bajada respecto a la proporci贸n de subida
  k <- d2 / u2
  
  ## probabilidad de subida en el 谩rbol de tasa corta
  q <- (1 - d2) / (u2 - d2)
  
  # vectores para guardar el resultado de la dinamica del mercado (precio de la acci贸n)
  valor.accion.vec  <- numeric(cant.periodos + 1)
  probabilidad.vec <- numeric(cant.periodos + 1)
  trayectoria.vec <- numeric(cant.periodos + 1)

  
  # valores iniciales del dataframe
  valor.accion.vec[1] <- valor.accion
  probabilidad.vec[1] <- 1 # evento seguro, ya que es conocido hoy
  trayectoria.vec[1] <- 0
  
  
  # Caso base:
  
  ## probabilidad de subida del valor de las acciones
  prob.subida <- prob.subida(u, d, tasa.corta$rt[1])
  
  ## se calcula si la accci贸n sube o baja con una bernulli(prob.subida) 
  trayectoria.vec[2] <- rbinom(1, 1, prob.subida)
  
  ## valor de la acci贸n en t = 1
  if(trayectoria.vec[2] == 1){
    valor.accion.vec[2] <- valor.accion.vec[1] * u
    probabilidad.vec[2] <- prob.subida
  } else{
    valor.accion.vec[2] <- valor.accion.vec[1] * d
    probabilidad.vec[2] <- 1 - prob.subida
  }
  
  # Caso general:
  for (i in 2:cant.periodos){

    # probabilidad de subida del valor de las acciones
    prob.subida <- prob.subida(u, d, tasa.corta$rt[i + 1])
    
    # se calcula si la accci贸n sube o baja con una bernulli(prob.subida) 
    trayectoria.vec[i + 1] <- rbinom(1, 1, prob.subida)
    
    # valor de la acci贸n en t = i + 1
    
    ## sube en el 谩rbol de acciones
    if(trayectoria.vec[i + 1] == 1){
      St <- valor.accion.vec[i] * u
      ## sube en el 谩rbol de tasa corta
      if(tasa.corta$Ut[i + 1] > tasa.corta$Ut[i]){
        prob <- prob.subida * q
      } 
      ## baja en el 谩rbol de tasa corta
      else{ 
        prob <- prob.subida * (1 - q) 
      }
    } 
    ## baja en el 谩rbol de acciones
    else{
      St <- valor.accion.vec[i] * d
      ## sube en el 谩rbol de tasa corta
      if(tasa.corta$Ut[i + 1] > tasa.corta$Ut[i]){
        prob <- (1 - prob.subida) * q
      ## baja en el 谩rbol de tasa corta
      } else{
        prob <- (1 - prob.subida) * (1 - q)
      }
    }
    
    valor.accion.vec[i + 1] <- St
    probabilidad.vec[i + 1] <- prob
  }
  
  return(data.frame(periodo = 0:cant.periodos,
                    valor.accion  = valor.accion.vec,
                    trayectoria.accion = trayectoria.vec,
                    probabilidad = probabilidad.vec))
}
```

## Precios Ho Lee

```{r}
precios.ho.lee <- function(u2, d2, curva, S, T, trayectoria.tasa.corta){
  
  # proporci贸n de bajada respecto a la proporci贸n de subida
  k <- d2 / u2
  
  # probabilidad de subida en el 谩rbol de tasa corta
  q <- (1 - d2) / (u2 - d2)
  
  # calcular el precio forward
  precio.forward <- precios.forward(S, T, curva)
  
  # N煤mero de meses hasta S
  S <- ceiling(S * 12 * 100) / 100
  T <- ceiling(T * 12 * 100) / 100
  
  # Filtrar trayectoria hasta S y sumar para obtener la cantidad de subidas hasta S
  # Nota: trayectoria.tasa.corta comienza en t = 0, por lo que se debe de sumar 1
  Us <- sum(trayectoria.tasa.corta[seq_len(S+1)])
  
  # inicializa la productoria
  prod <- 1
  
  
  for(n in 1:(T-S)){
    # calcular la proporci贸n de bajada para n
    dn <- k^(n - 1) / ((1 - q) * k^(n - 1) + q)
    
    # calcular la proporci贸n de bajada para n + s
    d.n.plus.s <- k^(n + S - 1) / ((1 - q) * k^(n + S - 1) + q)
    
    # productoria del cociente d(n+s) / d(n)
    prod <- prod * d.n.plus.s / dn
  }
  
  # proporci贸n de subida u(T-S+1)
  u <- 1 / ((1-q) * k^(T - S) + q)
  
  # proporci贸n de bajada d(T-S+1)
  d <- k^(T - S) / ((1 - q) * k^(T - S) + q)
  
  precio <- precio.forward * prod * (u / d)^Us
  
  return(precio)
}
```

## Valorar bonos cero cupon y bonos cuponados

```{r}
acumular.hasta.S <- function(S, venc, valores.tasa.corta){
  
  tiempo.inicio <- ceiling(venc * 12 * 100) / 100
  tiempo.final <- ceiling(S * 12 * 100) / 100
  
  if(tiempo.inicio >= tiempo.final){
    return(1)
  } 
  else{
    tasas <- valores.tasa.corta[(tiempo.inicio + 1):(tiempo.final)]
    return(exp(sum(tasas)))
  }
}
```

```{r}
valor.bonos <- function(S, curva, venc, valor, u2 = NULL, d2 = NULL, tasa.corta = NULL){
  if(S == 0){
      df.filtrado <- curva %>% 
      filter(vencimiento %in% venc)
  
    return(sum(df.filtrado$precio * valor))
  } else{
    
    S <- ceiling(S * 100) / 100
    
    precios <- numeric(length(venc))
    
    for(i in seq_along(venc)){
      
      # Se acumulan los bonos que ya hayan vencido para el tiempo S
      if(venc[i] < S){
        precios[i] <- acumular.hasta.S(S = S, venc = venc[i], 
                                       valores.tasa.corta = tasa.corta$rt)
      } 
      
      # Bonos que venzan en la fecha donde se este valorando el portafolio valen 1
      if(venc[i] == S){
        precios[i] <- 1
      }
      
      # Se cuentan los bonos que aun esten en el portafolio
      else{
        precios[i] <- precios.ho.lee(u2, d2, curva, S, venc[i], trayectoria.tasa.corta = tasa.corta$trayectoria)
      }
    }
    
    return(sum(precios * valor))
  }
}

valor.bonos.cuponados <- function(S, curva, venc, periodo.cupon, valor, cupon,  u2 = NULL, d2 = NULL, tasa.corta = NULL){
  
  monto <- 0
  
  for(indice in seq(length(venc))){
    
    # Fechas de cup贸n
    venc.cupones <- seq(periodo.cupon[indice] / 12, 
                        venc[indice], 
                        periodo.cupon[indice] / 12)
    
    # valor del cup贸n
    valor.cupon <- valor * cupon[indice]
    
    # valor total de los cupones en S
    cupones <- valor.bonos(S, curva, venc.cupones, valor.cupon, u2, d2, tasa.corta)
    
    # valor total del principal en S
    principal <- valor.bonos(S, curva, venc[indice], valor, u2, d2, tasa.corta)
    
    
    monto <- monto + cupones + principal
  }
  
  return(monto)
}
```

## Tipo de cambio forward

```{r}
tipo.cambio.forward <- function(S, tipo.cambio.actual, curva.CRC, curva.USD){
  # Precio cero cupon P(0, S) de Costa Rica
  data.S.CRC <- curva.CRC %>% filter(curva.CRC$vencimiento == ceiling(S * 100) / 100)
  
  # Precio cero cupon P(0, S) de Estados Unidos 
  data.S.USD <- curva.USD %>% filter(curva.USD$vencimiento == ceiling(S * 100) / 100)
  
  # tipo de cambio forward CRC/USD
  tipo.cambio.forward <- tipo.cambio.actual * data.S.USD$precio / data.S.CRC$precio
  
  return(tipo.cambio.forward)
}
```

## Caminatas

```{r}
trayectoria <- function(u2, d2, cant.pasos){
  
  # probabilidad de subida en el 谩rbol de tasa corta
  prob <- (1 - d2) / (u2 - d2)
  
  # trayectoria generada de unos y ceros apartir de una bernulli(prob)
  trayectoria <- rbinom(cant.pasos, 1, prob)
  
  return(trayectoria)
}
```

## Simulaciones

```{r}
montecarlo <- function(S, u2.CRC, d2.CRC, u.CRC, d.CRC,
                       u2.USD, d2.USD, u.USD, d.USD,
                       curva.CRC, curva.USD, 
                       valor.accion.CRC, cant.acciones.CRC, 
                       valor.accion.USD, cant.acciones.USD,
                       valor.bonos.CRC, venc.bonos.CRC,
                       valor.bonos.USD, venc.bonos.USD,
                       valor.bonos.cuponados.CRC, venc.bonos.cuponados.CRC,
                       periodo.cupon.CRC, cupon.CRC,
                       valor.bonos.cuponados.USD, venc.bonos.cuponados.USD,
                       periodo.cupon.USD, cupon.USD,
                       tipo.cambio,
                       cant.simulaciones){
  
  tipo.cambio.forward <- 498.16
  
  simulacion.vec <- numeric(cant.simulaciones)
  acciones.CRC.vec <- numeric(cant.simulaciones)
  bonos.cero.cupon.CRC.vec <- numeric(cant.simulaciones)
  bonos.cuponados.CRC.vec <- numeric(cant.simulaciones)
  acciones.USD.vec <- numeric(cant.simulaciones)
  bonos.cero.cupon.USD.vec <- numeric(cant.simulaciones)
  bonos.cuponados.USD.vec <- numeric(cant.simulaciones)
  portafolio.CRC.vec <- numeric(cant.simulaciones)
  portafolio.USD.vec <- numeric(cant.simulaciones)
  tipo.cambio.vec <- numeric(cant.simulaciones)
  total.portafolio.vec <- numeric(cant.simulaciones)
  Ut.tasa.corta.CRC.vec <- numeric(cant.simulaciones)
  Ut.tasa.corta.USD.vec <- numeric(cant.simulaciones)
  
  
  for(sim in 1:cant.simulaciones){
    
    # trayectorias
    trayectoria.tasa.corta.CRC <- trayectoria(u2.CRC, d2.CRC, S*12)
    trayectoria.tasa.corta.USD <- trayectoria(u2.USD, d2.USD, S*12)
    
    # tasas cortas
    
    ## Costa Rica
    tasa.corta.CRC <- modelo.ho.lee(u2 = u2.CRC, d2 = d2.CRC, curva = curva.CRC, cant.periodos = S*12, trayectoria.tasa.corta = trayectoria.tasa.corta.CRC)
    
    ## Estados Unidos 
    tasa.corta.USD <- modelo.ho.lee(u2 = u2.USD, d2 = d2.USD, curva = curva.USD, cant.periodos = S*12, trayectoria.tasa.corta = trayectoria.tasa.corta.USD)    
    
    # mercado de Costa Rica
    
    ## mercado de acciones Costa Rica
    acciones.CRC <- mercado.acciones(u2 = u2.CRC, d2 = d2.CRC, 
                                     u = u.CRC, d = d.CRC, 
                                     curva = curva.CRC, 
                                     cant.periodos = S*12, 
                                     valor.accion = valor.accion.CRC, 
                                     tasa.corta.CRC)$valor.accion[S * 12 + 1] * cant.acciones.CRC

    ## Bonos cero cup贸n de Costa Rica
    bonos.CRC <- valor.bonos(S = S, curva = curva.CRC, 
                             venc = venc.bonos.CRC, valor = valor.bonos.CRC, 
                             u2 = u2.CRC, d2 = d2.CRC, tasa.corta = tasa.corta.CRC)
    
    ## Bonos cuponados de Costa Rica
    bonos.cuponados.CRC <- valor.bonos.cuponados(S = S, curva = curva.CRC, 
                          venc = venc.bonos.cuponados.CRC, 
                          periodo.cupon = periodo.cupon.CRC, 
                          valor = valor.bonos.cuponados.CRC, 
                          cupon = cupon.CRC,  
                          u2 = u2.CRC, 
                          d2 = d2.CRC,
                          tasa.corta = tasa.corta.CRC)

    
    # Mercado de Estados Unidos
    
    ## mercado de acciones Estados Unidos
    acciones.USD <- mercado.acciones(u2 = u2.USD, d2 = d2.USD, 
                                     u = u.USD, d = d.USD, 
                                     curva = curva.USD, cant.periodos = S*12, 
                                     valor.accion = valor.accion.USD, 
                                     tasa.corta = tasa.corta.USD)$valor.accion[S * 12 + 1] * cant.acciones.USD
    
    ## Bonos cero cup贸n de Estados Unidos
    bonos.USD <- valor.bonos(S = S, curva = curva.USD, 
                             venc = venc.bonos.USD, valor = valor.bonos.USD, 
                             u2 = u2.USD, d2 = d2.USD, 
                             tasa.corta = tasa.corta.USD)
    
    ## Bonos cuponados de Estados Unidos
    bonos.cuponados.USD <- valor.bonos.cuponados(S = S, curva = curva.USD, 
                          venc = venc.bonos.cuponados.USD, 
                          periodo.cupon = periodo.cupon.USD, 
                          valor = valor.bonos.cuponados.USD, 
                          cupon = cupon.USD,  
                          u2 = u2.USD, 
                          d2 = d2.USD,
                          tasa.corta = tasa.corta.USD)
    
    # Valor del portafolio de las acciones, bonos cero cupon y bonos cuponados de Costa Rica
    portafolio.CRC <- acciones.CRC + bonos.CRC + bonos.cuponados.CRC
    
    # Valor del portafolio de las acciones, bonos cero cupon y bonos cuponados de Estados Unidos
    portafolio.USD <- acciones.USD + bonos.USD + bonos.cuponados.USD
    
    # Valor total del portafolio en colones
    portafolio <- portafolio.CRC + portafolio.USD * tipo.cambio.forward
    
    simulacion.vec[sim] <- sim
    acciones.CRC.vec[sim] <- acciones.CRC
    bonos.cero.cupon.CRC.vec[sim] <- bonos.CRC
    bonos.cuponados.CRC.vec[sim] <- bonos.cuponados.CRC
    acciones.USD.vec[sim] <- acciones.USD
    bonos.cero.cupon.USD.vec[sim] <- bonos.USD
    bonos.cuponados.USD.vec[sim] <- bonos.cuponados.USD
    portafolio.CRC.vec[sim] <- portafolio.CRC
    portafolio.USD.vec[sim] <- portafolio.USD
    tipo.cambio.vec[sim] <- tipo.cambio.forward
    total.portafolio.vec[sim] <- portafolio
    Ut.tasa.corta.CRC.vec[sim] <- sum(trayectoria.tasa.corta.CRC)
    Ut.tasa.corta.USD.vec[sim] <- sum(trayectoria.tasa.corta.USD)
    
  }
  return(data.frame(
          simulacion = simulacion.vec,
          acciones.CRC = acciones.CRC.vec,
          bonos.cero.cupon.CRC = bonos.cero.cupon.CRC.vec,
          bonos.cuponados.CRC = bonos.cuponados.CRC.vec,
          acciones.USD = acciones.USD.vec,
          bonos.cero.cupon.USD = bonos.cero.cupon.USD.vec,
          bonos.cuponados.USD = bonos.cuponados.USD.vec,
          portafolio.CRC = portafolio.CRC.vec,
          portafolio.USD = portafolio.USD.vec,
          tipo.cambio = tipo.cambio.vec,
          total.portafolio = total.portafolio.vec,
          Ut.tasa.corta.CRC = Ut.tasa.corta.CRC.vec,
          Ut.tasa.corta.USD = Ut.tasa.corta.USD.vec
  ))
}
  
```

```{r}
valor.actual.portafolio <- function(S,
                       curva.CRC, curva.USD, 
                       valor.accion.CRC, cant.acciones.CRC, 
                       valor.accion.USD, cant.acciones.USD,
                       valor.bonos.CRC, venc.bonos.CRC,
                       valor.bonos.USD, venc.bonos.USD,
                       valor.bonos.cuponados.CRC, venc.bonos.cuponados.CRC,
                       periodo.cupon.CRC, cupon.CRC,
                       valor.bonos.cuponados.USD, venc.bonos.cuponados.USD,
                       periodo.cupon.USD, cupon.USD,
                       tipo.cambio){
  
    # mercado de Costa Rica
    
    ## mercado de acciones Costa Rica
    acciones.CRC <- valor.accion.CRC * cant.acciones.CRC
    
    ## Bonos cero cup贸n de Costa Rica
    bonos.CRC <- valor.bonos(S = S, curva = curva.CRC, 
                             venc = venc.bonos.CRC, valor = valor.bonos.CRC)
    
    ## Bonos cuponados de Costa Rica
    bonos.cuponados.CRC <- valor.bonos.cuponados(S = S, curva = curva.CRC, 
                          venc = venc.bonos.cuponados.CRC, 
                          periodo.cupon = periodo.cupon.CRC, 
                          valor = valor.bonos.cuponados.CRC, 
                          cupon = cupon.CRC)

    
    # Mercado de Estados Unidos
    
    ## mercado de acciones Estados Unidos
    acciones.USD <- valor.accion.USD * cant.acciones.USD
    
    ## Bonos cero cup贸n de Estados Unidos
    bonos.USD <- valor.bonos(S = S, curva = curva.USD, 
                             venc = venc.bonos.USD, valor = valor.bonos.USD)
    
    ## Bonos cuponados de Estados Unidos
    bonos.cuponados.USD <- valor.bonos.cuponados(S = S, curva = curva.USD, 
                          venc = venc.bonos.cuponados.USD, 
                          periodo.cupon = periodo.cupon.USD, 
                          valor = valor.bonos.cuponados.USD, 
                          cupon = cupon.USD)
    
    # Valor del portafolio de las acciones, bonos cero cupon y bonos cuponados de Costa Rica
    portafolio.CRC <- acciones.CRC + bonos.CRC + bonos.cuponados.CRC
    
    # Valor del portafolio de las acciones, bonos cero cupon y bonos cuponados de Estados Unidos
    portafolio.USD <- acciones.USD + bonos.USD + bonos.cuponados.USD
    
    # Valor total del portafolio en colones
    portafolio <- portafolio.CRC + portafolio.USD * tipo.cambio
    
    resultados <- data.frame(
      acciones.CRC = acciones.CRC,
      bonos.cero.cupon.CRC = bonos.CRC,
      bonos.cuponados.CRC = bonos.cuponados.CRC,
      acciones.USD = acciones.USD,
      bonos.cero.cupon.USD = bonos.USD,
      bonos.cuponados.USD = bonos.cuponados.USD,
      portafolio.CRC = portafolio.CRC,
      portafolio.USD = portafolio.USD,
      tipo.cambio = tipo.cambio,
      total.portafolio = portafolio
    )
  return(resultados)
}
```

## Cox Ross Rubinstein

```{r}
pan <- read_excel("../data/pan.xlsx")

pai <- read_excel("../data/pai.xlsx")

precpan <- as.numeric(pan$Precio)

precpai <- as.numeric(pai$`Close Price`)

```

### Hallar par谩metros bajo CRR

```{r}
rendpan.log <- diff(log(precpan))
rendpai.log <- diff(log(precpai))

sigma.mensualpan <- sd(rendpan.log)
sigmapan <- sigm._mensualpan * sqrt(12)

sigma.mensualpai <- sd(rendpai.log)
sigmapai <- sigma.mensualpai * sqrt(12)

delta_t <- 1/12

upan <- exp(sigmapan * sqrt(delta.t))
dpan <- exp(-sigmapan * sqrt(delta.t))
upai <- exp(sigmapai * sqrt(delta.t))
dpai <- exp(-sigmapai * sqrt(delta.t))
dpai
```

## Ajustar distribuciones

```{r}
library(fitdistrplus)
ajustar.distribucion <- function(
  x,
  distribuciones = c("lnorm", "weibull", "norm")
){
  # Limpieza
  x <- x[is.finite(x) & x > 0]
  if(length(x) < 10){
    stop("Muy pocos datos para ajustar distribuciones.")
  }
  
  fits <- list()
  
  for(d in distribuciones){
    fit <- tryCatch(
      suppressWarnings(
        fitdist(x, d)
      ),
      error = function(e) NULL
    )
    
    if(!is.null(fit) && all(is.finite(fit$estimate))){
      fits[[d]] <- fit
    }
  }
  
  if(length(fits) == 0){
    stop("Ninguna distribuci贸n pudo ajustarse.")
  }
  
  tabla <- do.call(rbind, lapply(names(fits), function(d){
    fit <- fits[[d]]
    
    data.frame(
      Distribucion = d,
      AIC = AIC(fit),
      BIC = BIC(fit)
    )
  }))
  return(tabla)
}
```

## Gr谩fico de la distribuci贸n

```{r}
library(ggplot2)
library(MASS)
library(scales)
library(tibble)


graficar.ajuste <- function(
  x,
  distribucion = c("lnorm", "weibull", "norm"),
  titulo = "Ajuste de distribuci贸n",
  horizonte = NULL
){
  distribucion <- match.arg(distribucion)
  
  # Limpieza
  x <- x[is.finite(x) & x > 0]
  if(length(x) < 10){
    stop("Muy pocos datos para graficar.")
  }
  
  #  Mapeo correcto para MASS::fitdistr
  dist_mass <- switch(
    distribucion,
    lnorm   = "lognormal",
    norm    = "normal",
    weibull = "weibull"
  )
  
  # Ajuste MLE
  fit <- MASS::fitdistr(x, dist_mass)
  est <- fit$estimate
  
  # Media, desviaci贸n y densidad
  if(distribucion == "lnorm"){
    media <- exp(est["meanlog"] + est["sdlog"]^2 / 2)
    desv  <- sqrt((exp(est["sdlog"]^2) - 1) * exp(2*est["meanlog"] + est["sdlog"]^2))
    dens_fun  <- dlnorm
    dens_args <- list(meanlog = est["meanlog"], sdlog = est["sdlog"])
    
  } else if(distribucion == "weibull"){
    media <- est["scale"] * gamma(1 + 1 / est["shape"])
    desv  <- sqrt(est["scale"]^2 *
                   (gamma(1 + 2/est["shape"]) -
                    gamma(1 + 1/est["shape"])^2))
    dens_fun  <- dweibull
    dens_args <- list(shape = est["shape"], scale = est["scale"])
    
  } else if(distribucion == "norm"){
    media <- est["mean"]
    desv  <- est["sd"]
    dens_fun  <- dnorm
    dens_args <- list(mean = est["mean"], sd = est["sd"])
  }
  
  subtitulo <- paste0(
    if(!is.null(horizonte)) paste0("Horizonte: ", horizonte, " a帽os | ") else "",
    "Media = ", round(media / 1e6, 2), " M",
    " | Desv.Est = ", round(desv / 1e6, 2), " M"
  )
  
  ggplot(tibble(x = x), aes(x = x)) +
    geom_histogram(
      aes(y = after_stat(density)),
      bins = nclass.FD(x),
      fill = "#4E79A7",
      color = "white",
      alpha = 0.85
    ) +
    stat_function(
      fun = dens_fun,
      args = dens_args,
      linewidth = 1.5,
      color = "#E15759"
    ) +
    scale_x_continuous(
      labels = label_number(scale = 1e-6, suffix = " M")
    ) +
    labs(
      title = titulo,
      subtitle = subtitulo,
      x = "Valor del portafolio (millones)",
      y = "Densidad"
    ) +
    theme_minimal(base_size = 10) +
    theme(
      plot.title = element_text(face = "bold"),
      panel.grid.minor = element_blank()
    )
}


```

## Estadisticas

```{r}
estadisticas.riesgo <- function(
  x,
  distribucion = c("lnorm", "norm", "weibull"),
  alphas = c(0.05, 0.70),
  escala.millones = TRUE
){
  distribucion <- match.arg(distribucion)
  
  # limpieza
  x <- x[is.finite(x)]
  if(distribucion %in% c("lnorm", "weibull")){
    x <- x[x > 0]
  }
  if(length(x) < 10){
    stop("Muy pocos datos para calcular estad铆sticas.")
  }
  
  # ---- Ajuste MLE ----
  dist_mass <- switch(
    distribucion,
    lnorm   = "lognormal",
    norm    = "normal",
    weibull = "weibull"
  )
  
  fit <- MASS::fitdistr(x, dist_mass)
  est <- fit$estimate
  
  # funciones VaR / CVaR
  resultados <- lapply(alphas, function(alpha){
    
    if(distribucion == "lnorm"){
      q <- qlnorm(alpha, est["meanlog"], est["sdlog"])
      EX <- exp(est["meanlog"] + 0.5 * est["sdlog"]^2)
      z  <- (log(q) - est["meanlog"] - est["sdlog"]^2) / est["sdlog"]
      cvar <- EX * pnorm(z) / alpha
      
    } else if(distribucion == "norm"){
      q <- qnorm(alpha, est["mean"], est["sd"])
      cvar <- est["mean"] - est["sd"] * dnorm(qnorm(alpha)) / alpha
      
    } else if(distribucion == "weibull"){
      q <- qweibull(alpha, est["shape"], est["scale"])
      # CVaR Weibull (cola izquierda)
      cvar <- est["scale"] * gamma(1 + 1 / est["shape"]) *
              pgamma((q / est["scale"])^est["shape"],
                     shape = 1 + 1 / est["shape"]) / alpha
    }
    
    c(VaR = q, CVaR = cvar)
  })
  
  tabla <- do.call(rbind, resultados)
  rownames(tabla) <- paste0("alpha = ", alphas)
  
  if(escala.millones){
    tabla <- tabla / 1e6
  }
  
  colnames(tabla) <- c("VaR", "CVaR")
  
  round(tabla, 3)
}

```

# Secci贸n 1

```{r}

# Extrae la curva cero cupon (rhos) para Costa Rica y Estados Unidos
CCC <- read.csv("../data/Curvas Cero Cup贸n.csv", sep = ";")

# Curva de Precios bono cero cupon de Costa Rica
CCC.colones <- CCC %>%
  mutate(
    precio = 1 / (1 + Curva.Cero.Cup贸n.BCCR..Colones. / 100) ^ vencimiento
  ) %>%
  dplyr::select(vencimiento, precio)

# Curva de Precios bono cero cupon de Estados Unidos
CCC.dolares <- CCC %>%
  mutate(
    precio = 1 / (1 + Curva.Cero.Cup贸n.FED..D贸lares. / 100) ^ vencimiento
    ) %>% 
  dplyr::select(vencimiento, precio)
```

## Valor del portafolio en \$t=0\$

```{r}
portafolio <- valor.actual.portafolio(S = 0, curva.CRC = CCC.colones, curva.USD = CCC.dolares, 
                       valor.accion.CRC = 23000, cant.acciones.CRC = 600, 
                       valor.accion.USD = 135, cant.acciones.USD = 400,
                       valor.bonos.CRC = 12000000, venc.bonos.CRC = c(3, 8, 15, 20),
                       valor.bonos.USD = 14500, venc.bonos.USD = c(5, 10, 16),
                       valor.bonos.cuponados.CRC = 21000000, venc.bonos.cuponados.CRC = c(10, 12, 15, 18),
                       periodo.cupon.CRC = c(2, 3, 4, 12), cupon.CRC = c(0.04, 0.06, 0.07, 0.09),
                       valor.bonos.cuponados.USD = 30000, venc.bonos.cuponados.USD = c(17),
                       periodo.cupon.USD = c(12), cupon.USD = c(0.06),
                       tipo.cambio = 498.19)

portafolio

write.csv(
  portafolio,
  file = "../Resultados/valor_actual_portafolio.csv",
  row.names = FALSE
)
```

## Valor del portafolio en $t=4$

```{r}
valor.portafolioh4 <- montecarlo(S = 15, u2.CRC = 1.0003, d2.CRC = 0.9997, u.CRC = 1.061934, d.CRC = 0.9416777,
                       u2.USD = 1.00005, d2.USD = 0.99995, u.USD = 1.043396, d.USD = 0.9584087,
                       curva.CRC = CCC.colones, curva.USD = CCC.dolares, 
                       valor.accion.CRC = 23000, cant.acciones.CRC = 600, 
                       valor.accion.USD = 135, cant.acciones.USD = 400,
                       valor.bonos.CRC = 12000000, venc.bonos.CRC = c(3, 8, 15, 20),
                       valor.bonos.USD = 14500, venc.bonos.USD = c(5, 10, 16),
                       valor.bonos.cuponados.CRC = 21000000, venc.bonos.cuponados.CRC = c(10, 12, 15, 18),
                       periodo.cupon.CRC = c(2, 3, 4, 12), cupon.CRC = c(0.04, 0.06, 0.07, 0.09),
                       valor.bonos.cuponados.USD = 30000, venc.bonos.cuponados.USD = c(17),
                       periodo.cupon.USD = c(12), cupon.USD = c(0.06),
                       tipo.cambio = 498.19,
                       cant.simulaciones = 10)

valor.portafolioh4

write.csv(
  valor.portafolioh4,
  file = "../Resultados/valor_portafolio_h4.csv",
  row.names = FALSE
)
```

### Ajustar distribuci贸n del portafolio en el horizonte 4

```{r}
portafolio.h4 <- read_delim("../resultados/valor_portafolio_h4.csv", delim = ",")

h4 <- portafolio.h4$total.portafolio

ajustar.distribucion(h4)

grafica.h4 <- graficar.ajuste(x = h4, distribucion = c("lnorm"), titulo = "Portafolio en horizonte de 4 a帽os con ajuste LogNormal")

ggsave(
  filename = "../Resultados/portafolio_h4_lognormal.jpg",
  plot = grafica.h4,
  width = 8,
  height = 5,
  units = "in",
  dpi = 300
)
```

### Estad铆sticas de riesgo

```{r}
estadisticas.riesgo(
  x = h4,
  distribucion = c("lnorm"),
  alphas = c(0.05, 0.70),
  escala.millones = TRUE
)
```

## Valor del portafolio en $t=7$

```{r}
valor.portafolioh7 <- montecarlo(S = 7, u2.CRC = 1.0003, d2.CRC = 0.9997, u.CRC = 1.061934, d.CRC = 0.9416777,
                       u2.USD = 1.00005, d2.USD = 0.99995, u.USD = 1.043396, d.USD = 0.9584087,
                       curva.CRC = CCC.colones, curva.USD = CCC.dolares, 
                       valor.accion.CRC = 23000, cant.acciones.CRC = 600, 
                       valor.accion.USD = 135, cant.acciones.USD = 400,
                       valor.bonos.CRC = 12000000, venc.bonos.CRC = c(3, 8, 15, 20),
                       valor.bonos.USD = 14500, venc.bonos.USD = c(5, 10, 16),
                       valor.bonos.cuponados.CRC = 21000000, venc.bonos.cuponados.CRC = c(10, 12, 15, 18),
                       periodo.cupon.CRC = c(2, 3, 4, 12), cupon.CRC = c(0.04, 0.06, 0.07, 0.09),
                       valor.bonos.cuponados.USD = 30000, venc.bonos.cuponados.USD = c(17),
                       periodo.cupon.USD = c(12), cupon.USD = c(0.06),
                       tipo.cambio = 498.19,
                       cant.simulaciones = 10000)

write.csv(
  valor.portafolioh7,
  file = "../Resultados/valor_portafolio_h7.csv",
  row.names = FALSE
)
```

### Ajustar distribuci贸n del portafolio en el horizonte 7

```{r}
portafolio.h7 <- read_delim("../resultados/valor_portafolio_h7.csv", delim = ",")

h7 <- portafolio.h7$total.portafolio

ajustar.distribucion(h7)

grafica.h7 <- graficar.ajuste(x = h7, distribucion = c("lnorm"), titulo = "Portafolio en horizonte de 4 a帽os con ajuste LogNormal")

ggsave(
  filename = "../Resultados/portafolio_h7_lognormal.jpg",
  plot = grafica.h7,
  width = 8,
  height = 5,
  units = "in",
  dpi = 300
)
```

### Estad铆sticas de riesgo

```{r}
estadisticas.riesgo(
  x = h7,
  distribucion = c("lnorm"),
  alphas = c(0.05, 0.70),
  escala.millones = TRUE
)
```

## Valor del portafolio en $t=10$

```{r}
valor.portafolioh10 <- montecarlo(S = 10, u2.CRC = 1.0003, d2.CRC = 0.9997, u.CRC = 1.061934, d.CRC = 0.9416777,
                       u2.USD = 1.00005, d2.USD = 0.99995, u.USD = 1.043396, d.USD = 0.9584087,
                       curva.CRC = CCC.colones, curva.USD = CCC.dolares, 
                       valor.accion.CRC = 23000, cant.acciones.CRC = 600, 
                       valor.accion.USD = 135, cant.acciones.USD = 400,
                       valor.bonos.CRC = 12000000, venc.bonos.CRC = c(3, 8, 15, 20),
                       valor.bonos.USD = 14500, venc.bonos.USD = c(5, 10, 16),
                       valor.bonos.cuponados.CRC = 21000000, venc.bonos.cuponados.CRC = c(10, 12, 15, 18),
                       periodo.cupon.CRC = c(2, 3, 4, 12), cupon.CRC = c(0.04, 0.06, 0.07, 0.09),
                       valor.bonos.cuponados.USD = 30000, venc.bonos.cuponados.USD = c(17),
                       periodo.cupon.USD = c(12), cupon.USD = c(0.06),
                       tipo.cambio = 498.19,
                       cant.simulaciones = 10000)

write.csv(
  valor.portafolioh10,
  file = "../Resultados/valor_portafolio_h10.csv",
  row.names = FALSE
)
```

### Ajustar distribuci贸n del portafolio en el horizonte 10

```{r}
portafolio.h10 <- read_delim("../resultados/valor_portafolio_h10.csv", delim = ",")

h10 <- portafolio.h10$total.portafolio

ajustar.distribucion(h10)

grafica.h10 <- graficar.ajuste(x = h10, distribucion = c("lnorm"), titulo = "Portafolio en horizonte de 10 a帽os con ajuste LogNormal")

ggsave(
  filename = "../Resultados/portafolio_h10_lognormal.jpg",
  plot = grafica.h10,
  width = 8,
  height = 5,
  units = "in",
  dpi = 300
)
```

### Estad铆sticas de riesgo

```{r}
estadisticas.riesgo(
  x = h10,
  distribucion = c("lnorm"),
  alphas = c(0.05, 0.70),
  escala.millones = TRUE
)
```

## Valor del portafolio en $t=15$

```{r}
valor.portafolioh15 <- montecarlo(S = 15, u2.CRC = 1.0003, d2.CRC = 0.9997, u.CRC = 1.061934, d.CRC = 0.9416777,
                       u2.USD = 1.00005, d2.USD = 0.99995, u.USD = 1.043396, d.USD = 0.9584087,
                       curva.CRC = CCC.colones, curva.USD = CCC.dolares, 
                       valor.accion.CRC = 23000, cant.acciones.CRC = 600, 
                       valor.accion.USD = 135, cant.acciones.USD = 400,
                       valor.bonos.CRC = 12000000, venc.bonos.CRC = c(3, 8, 15, 20),
                       valor.bonos.USD = 14500, venc.bonos.USD = c(5, 10, 16),
                       valor.bonos.cuponados.CRC = 21000000, venc.bonos.cuponados.CRC = c(10, 12, 15, 18),
                       periodo.cupon.CRC = c(2, 3, 4, 12), cupon.CRC = c(0.04, 0.06, 0.07, 0.09),
                       valor.bonos.cuponados.USD = 30000, venc.bonos.cuponados.USD = c(17),
                       periodo.cupon.USD = c(12), cupon.USD = c(0.06),
                       tipo.cambio = 498.19,
                       cant.simulaciones = 10000)

write.csv(
  valor.portafolioh15,
  file = "../Resultados/valor_portafolio_h15.csv",
  row.names = FALSE
)
```

### Ajustar distribuci贸n del portafolio en el horizonte 15

```{r}
portafolio.h15 <- read_delim("../resultados/valor_portafolio_h15.csv", delim = ",")

h15 <- portafolio.h15$total.portafolio

ajustar.distribucion(h15)

grafica.h15 <- graficar.ajuste(x = h15, distribucion = c("lnorm"), titulo = "Portafolio en horizonte de 15 a帽os con ajuste LogNormal")

ggsave(
  filename = "../Resultados/portafolio_h15_lognormal.jpg",
  plot = grafica.h15,
  width = 8,
  height = 5,
  units = "in",
  dpi = 300
)
```

### Estad铆sticas de riesgo

```{r}
estadisticas.riesgo(
  x = h15,
  distribucion = c("lnorm"),
  alphas = c(0.05, 0.70),
  escala.millones = TRUE
)
```

# Secci贸n 2

```{r}
valorar.compra.acciones <- function(S, u2.CRC, d2.CRC, u.CRC, d.CRC, 
                                    curva.CRC, valor.accion.CRC, cant.acciones.nuevas,
                                    Kf, cant.simulaciones){
  
  resultados <- data.frame(
    simulacion = rep(NA_real_, cant.simulaciones),
    acciones.CRC  = rep(NA_real_, cant.simulaciones),
    compra.directa = rep(NA_real_, cant.simulaciones),
    call.europea = rep(NA_real_, cant.simulaciones)
  )
  
  K <- Kf - 5000
  
  
  for(sim in 1:cant.simulaciones){
    
    # trayectorias
    trayectoria.tasa.corta.CRC <- trayectoria(u2.CRC, d2.CRC, S*12)
    
    # mercado de Costa Rica
    
    ## mercado de acciones Costa Rica
    acciones.CRC <- mercado.acciones(u2 = u2.CRC, d2 = d2.CRC, 
                                     u = u.CRC, d = d.CRC, 
                                     curva = curva.CRC, 
                                     cant.periodos = S*12, 
                                     valor.accion = valor.accion.CRC, 
                                     trayectoria.tasa.corta = trayectoria.tasa.corta.CRC)$valor.accion[S * 12 + 1]
    
    # Compra de acciones directa (independiente al valor que tome la accion en el a帽o 15)
    compra.directa <- cant.acciones.nuevas * acciones.CRC

    # Compra de acciones mediante una opcion call (depende del valor que tome la accion en el a帽o 15 y el strike) 
    call.europea <- cant.acciones.nuevas * pmax(acciones.CRC - K, 0)

    
    
    resultados[sim, ] <- c(
      simulacion = sim,
      acciones.CRC = acciones.CRC,
      compra.directa = compra.directa,
      call.europea = call.europea
    )
  }
  return(resultados)
}
```

```{r}

Kf <- 23000 * exp(15 * 12 * 0.0035)

nuevas.acciones <- valorar.compra.acciones(S = 15, u2.CRC = 1.0003, d2.CRC = 0.9997, 
                                           u.CRC = 1.061934, d.CRC = 0.9416777,
                                           curva.CRC = CCC.colones, valor.accion.CRC = 23000, 
                                           cant.acciones.nuevas = 300, Kf = Kf, cant.simulaciones = 10000)
write.csv(
  nuevas.acciones,
  file = "../Resultados/nuevas_acciones.csv",
  row.names = FALSE
)
```

## Resultados

### V铆a compra directa

```{r}

nuevas.acciones <- read_delim("../resultados/nuevas_acciones.csv", delim = ",")

compra.directa <- nuevas.acciones$compra.directa

mean(compra.directa)

mean(compra.directa + h15)

sd(compra.directa + h15)

```

### V铆a Opciones Call-Europea

```{r}

call.europea <- nuevas.acciones$call.europea

mean(call.europea)

sd(call.europea)

mean(call.europea + h15)

sd(call.europea + h15)
```
