---
title: "Proyecto de Valoraci贸n de Instrumentos Financieros I"
author: "Jeikel Navarro Solis, Lemuel M茅ndez Hidalgo, Cristhofer Urrutia Cascante"
format:
  html:
    toc: true            
    toc-depth: 3        
    toc-location: left   
    number-sections: true
    theme: united
    highlight-style: tango
    df-print: paged
execute:
  echo: true
---

# Cargar librer铆as

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(readr)
library(readxl)
library(fitdistrplus)
library(scales)
library(dplyr)
library(MASS)
library(ggplot2)
library(tibble)
```

# Funciones

## Precios forward

Se utiliza para calcular el precio forward $P_f(t; S, T)$, asumiendo que $t=0$

```{r}
precios.forward <- function(S, T, curva){
  # se redondea hacia arriba a dos decimales
  S <- ceiling(S * 100) / 100
  T <- ceiling(T * 100) / 100
  
  # se escoje la posicion de vencimiento que sea m谩s cercana
  S.curva <- which.min(abs(curva$vencimiento - S))
  T.curva <- which.min(abs(curva$vencimiento - T))
  
  return(curva$precio[T.curva] / curva$precio[S.curva])
}
```

## rbol de tasa corta

```{r}
modelo.ho.lee <- function(u2, d2, curva, cant.periodos, trayectoria.tasa.corta){
  
  # proporci贸n de bajada respecto a la proporci贸n de subida
  k    <- d2 / u2
  
  # log proporci贸n 
  logk <- log(k)
  
  # probabilidad de subida en el 谩rbol de tasa corta
  q    <- (1 - d2) / (u2 - d2)
  
  # tasa corta actual (t=0, S=0, T=1/12)
  r0 <- -log(precios.forward(0, 1/12, curva))
  
  # vectores para guardar los resultados de la trayectoria
  rt.vec <- numeric(cant.periodos + 1)
  Ut.vec <- integer(cant.periodos + 1)

  # se guardan los datos iniciales
  Ut <- 0
  rt.vec[1] <- r0
  Ut.vec[1] <- Ut
  
  # se anualiza el formato de cant.periodos y se genera un nuevo vector
  S.vec <- (1:cant.periodos) / 12
  
  # se genera un vector con las potencias de k
  k.potencias <- k^(1:cant.periodos)
  
  # se genera el vector de las proporciones de bajada en el 谩rbol de tasa corta
  dt1v <- k.potencias / ((1 - q) * k.potencias + q)

  # for que recorre cada periodo calculando y guardan la informaci贸n de esa rama del 谩rbol de tasa corta
  for(i in 1:cant.periodos){
    Ut <- Ut + (trayectoria.tasa.corta[i] == 1)
    rt.vec[i + 1] <- -log(precios.forward(S.vec[i], S.vec[i] + 1/12, curva)) - log(dt1v[i]) + Ut * logk
    Ut.vec[i + 1] <- Ut
  }

  return(data.frame(
    periodo = 0:cant.periodos,
    rt = rt.vec,
    trayectoria = c(0, trayectoria.tasa.corta[1:cant.periodos]),
    Ut = Ut.vec
  ))
}
```

## Dinamica de mercado

```{r}
prob.subida <- function(u, d, rt){
   # se verifican condiciones de no arbitraje, en caso de no cumplir se trunca el valor de rt para que no haya arbitraje
  if (exp(rt) > u){
    rt2 <- log(u)
  } else if (exp(rt) < d){
    rt2 <- log(d)
  } else {
    rt2 <- rt
  }
  
  # definici贸n cunado se cumplen las condiciones de arbitraje
  prob <- (exp(rt2) - d) / (u - d)
  return(prob)
}
```


```{r}
mercado.acciones <- function(u2, d2, u, d, curva, cant.periodos, valor.accion, tasa.corta){

  # probabilidad de subir en el 谩rbol de tasa corta
  q <- (1 - d2) / (u2 - d2)

  # vectores para guardar el resultado de la dinamica del mercado (precio de la acci贸n)
  valor.accion.vec <- numeric(cant.periodos + 1)
  prob.paso.vec    <- numeric(cant.periodos + 1)
  prob.acum.vec    <- numeric(cant.periodos + 1)
  trayectoria.vec  <- integer(cant.periodos + 1)

  # valores iniciales de la dinamica del mercado
  valor.accion.vec[1] <- valor.accion
  prob.paso.vec[1] <- 1
  prob.acum.vec[1] <- 1
  trayectoria.vec[1] <- 0

  for(i in 1:cant.periodos){
    
    # se calcula la probabilidad de subir en el 谩rbol de acciones
    p.subir <- prob.subida(u, d, tasa.corta$rt[i])

    # se genera "aleatoriamente" el movimiento en el arbol de acciones utilizando una bernoulli(p.subir)
    mov <- rbinom(1, 1, p.subir)
    
    # se guarda el moviento 
    trayectoria.vec[i + 1] <- mov

    # se guarda el valor de la acci贸n
    valor.accion.vec[i + 1] <- valor.accion.vec[i] * ifelse(mov == 1, u, d)

    # se crea una variable booleana que guarda el resultado de si se subi贸 la variable en el 谩rbol de tasa corta
    condicion <- (tasa.corta$Ut[i + 1] > tasa.corta$Ut[i])

    # probabilidad de dar ese paso con la dinamica del mercado
    p.paso <- if(mov == 1){
      p.subir * ifelse(condicion, q, 1 - q)
    } else {
      (1 - p.subir) * ifelse(condicion, q, 1 - q)
    }

    # guardar la informaci贸n de las probabilidades
    prob.paso.vec[i + 1] <- p.paso
    prob.acum.vec[i + 1] <- prob.acum.vec[i] * p.paso
  }

  data.frame(
    periodo = 0:cant.periodos,
    valor.accion = valor.accion.vec,
    trayectoria.accion = trayectoria.vec,
    prob.paso = prob.paso.vec,
    prob.acumulada = prob.acum.vec
  )
}


```

## Precios Ho Lee

```{r}
precio.ho.lee <- function(u2, d2, curva, S, T, trayectoria.tasa.corta){

  # proporci贸n de bajada respecto a la proporci贸n de subida
  k <- d2 / u2
  
  # probabilidad de subida en el 谩rbol de tasa corta
  q <- (1 - d2) / (u2 - d2)

  # forward P(0,T)/P(0,S)
  p.forward <- precios.forward(S, T, curva)

  # pasar de a帽os a meses enteros
  S.meses <- as.integer(ceiling(S * 12))
  T.meses <- as.integer(ceiling(T * 12))

  # Cortar la trayectoria hasta S y sumar para obtener la cantidad de subidas hasta S
  # Nota: trayectoria.tasa.corta comienza en t = 0, por lo que se debe de sumar 1
  Us <- sum(trayectoria.tasa.corta[1:(S.meses + 1)])  # incluye t=0

  # Productoria: prod_{n = 1}^{T.meses - S.meses} d(n + S.meses} / d(n)
  
  ## diferecia entre la cantidad de meses
  N <- T.meses - S.meses

  ## funci贸n de uso local para generar la proporci贸n de bajada de cada periodo
  dn <- function(n) k^(n - 1) / ((1 - q) * k^(n - 1) + q)

  ## vector con las proporciones de bajada de cada periodo
  bajada.vec <- sapply(1:N, function(n) dn(n + S.meses) / dn(n))
  valor.prod <- prod(bajada.vec)

  # proporciones de subida y bajada para N = T.meses - S.meses
  uN <- 1 / ((1 - q) * k^N + q)
  dN <- k^N / ((1 - q) * k^N + q)
  
  # precio forfawar del modelo ho lee para una trayectoria dada
  precio <- p.forward * valor.prod * (uN / dN)^Us

  return(precio)
}
```

## Valorar bonos cero cupon y bonos cuponados

```{r}
acumular.hasta.S <- function(S, venc, valores.tasa.corta){
  
  tiempo.i <- as.integer(ceiling(venc * 12))
  tiempo.f <- as.integer(ceiling(S * 12))
  
  # Caso en el que el tiempo inicial sea mayor al tiempo final
  if(tiempo.i >= tiempo.f){
    return(1)
  } 
  
  # caso contrario: se extraen los valores del vector de tasa corta que est茅n entre [tiempo.i + 1, tiempo.f]
  # Nota: el periodo de valores.trayectoria comienza en t=0.
  # Nota 2: recordar que rt es la tasa corta que acumula entre [t, t + 1]
  tasas <- valores.tasa.corta[(tiempo.i + 1):(tiempo.f)]
  
  # factor de acumulaci贸n: (1 + R) = e^{sum (rt)}
  return(exp(sum(tasas) * 1/12))
}
```

### Valorar bonos cero cup贸n

```{r}
valor.bonos <- function(S, curva, venc, valor, u2 = NULL, d2 = NULL, tasa.corta = NULL){
  
  S <- ceiling(S * 100) / 100
  venc <- ceiling(venc * 100) / 100
  
  # Caso en que se quiere valorar en 0
  if(S == 0){
    x <- match(venc, curva$vencimiento)
    precios <- curva$precio[x]
    return(sum(precios * valor))
  }
  
  # Caso cuando S > 0
  
  ## Se crea un vector que guarde valores de "precios" para los bonos cero cup贸n
  precios <- numeric(length(venc))

  for(i in seq_along(venc)){

    if(venc[i] < S){
      # ya venci贸: lo meto a la "cuenta de banco" y acumulo hasta S
      precios[i] <- acumular.hasta.S(
        S = S, venc = venc[i],
        valores.tasa.corta = tasa.corta$rt
      )

    } else if(venc[i] == S){
      # vence justo en S: vale 1
      precios[i] <- 1

    } else{
      # a煤n no vence: precio Ho-Lee condicionado
      precios[i] <- precio.ho.lee(
        u2, d2, curva, S, venc[i],
        trayectoria.tasa.corta = tasa.corta$trayectoria
      )
    }
  }

  sum(precios * valor)
}
```

### Valorar bonos cuponados

```{r}
valor.bonos.cuponados <- function(S, curva, venc, periodo.cupon, valor, cupon,
                                  u2 = NULL, d2 = NULL, tasa.corta = NULL){

  montos <- numeric(length(venc))

  for(indice in seq_along(venc)){
    # fechas de cup贸n 
    venc.cupones <- seq(
      from = periodo.cupon[indice] / 12,
      to   = venc[indice],
      by   = periodo.cupon[indice] / 12
    )
    
    # valor del cup贸n
    valor.cupon <- valor * cupon[indice]

    # Valor total en S de los cupones y principal para un bono cuponado
    cupones   <- valor.bonos(S, curva, venc.cupones, valor.cupon, u2, d2, tasa.corta)
    principal <- valor.bonos(S, curva, venc[indice],  valor,    u2, d2, tasa.corta)
  
    montos[indice] <- cupones + principal
  }

  sum(montos)
}

```

## Tipo de cambio forward

```{r}
tipo.cambio.forward <- function(S, tipo.cambio.actual, curva.CRC, curva.USD){
  # se redondea hacia arriba a dos decimales
  S <- ceiling(S * 100) / 100
  
  # se escoje la posicion de vencimiento que sea m谩s cercana
  S.CRC <- which.min(abs(curva.CRC$vencimiento - S))
  S.USD <- which.min(abs(curva.USD$vencimiento - S))
   
  # Precio cero cupon P(0, S) de Costa Rica
  data.S.CRC <- curva.CRC$precio[S.CRC]
  
  # Precio cero cupon P(0, S) de Estados Unidos 
  data.S.USD <- curva.USD$precio[S.USD]
  
  # tipo de cambio forward CRC/USD
  tipo.cambio <- tipo.cambio.actual * data.S.USD / data.S.CRC
  
  return(tipo.cambio)
}
```

## Caminatas

```{r}
trayectoria <- function(u2, d2, cant.pasos){
  
  # probabilidad de subida en el 谩rbol de tasa corta
  q <- (1 - d2) / (u2 - d2)
  
  # trayectoria generada de unos y ceros apartir de una bernulli(q)
  trayectoria <- rbinom(cant.pasos, 1, q)
  
  return(trayectoria)
}
```

## Simulaciones

### Montecarlo para simular el valor del portafolio en distintas trayectorias

```{r}
montecarlo <- function(S, u2.CRC, d2.CRC, u.CRC, d.CRC,
                       u2.USD, d2.USD, u.USD, d.USD,
                       curva.CRC, curva.USD, 
                       valor.accion.CRC, cant.acciones.CRC, 
                       valor.accion.USD, cant.acciones.USD,
                       valor.bonos.CRC, venc.bonos.CRC,
                       valor.bonos.USD, venc.bonos.USD,
                       valor.bonos.cuponados.CRC, venc.bonos.cuponados.CRC,
                       periodo.cupon.CRC, cupon.CRC,
                       valor.bonos.cuponados.USD, venc.bonos.cuponados.USD,
                       periodo.cupon.USD, cupon.USD,
                       tipo.cambio,
                       cant.simulaciones){
  
  cant.p <- as.integer(ceiling(S * 12 * 100) / 100)
  tipo.cambio.f <- tipo.cambio.forward(S, tipo.cambio, curva.CRC, curva.USD)
  
  # vectores para guardar la informaci贸n de cada simulaci贸n
  acciones.CRC.vec <- numeric(cant.simulaciones)
  bonos.cero.cupon.CRC.vec <- numeric(cant.simulaciones)
  bonos.cuponados.CRC.vec <- numeric(cant.simulaciones)
  acciones.USD.vec <- numeric(cant.simulaciones)
  bonos.cero.cupon.USD.vec <- numeric(cant.simulaciones)
  bonos.cuponados.USD.vec <- numeric(cant.simulaciones)
  portafolio.CRC.vec <- numeric(cant.simulaciones)
  portafolio.USD.vec <- numeric(cant.simulaciones)
  tipo.cambio.forward.vec <- numeric(cant.simulaciones)
  total.portafolio.vec <- numeric(cant.simulaciones)
  total.portafolio.TCF.vec <- numeric(cant.simulaciones)
  Ut.tasa.corta.CRC.vec <- numeric(cant.simulaciones)
  Ut.tasa.corta.USD.vec <- numeric(cant.simulaciones)
  
  for(sim in 1:cant.simulaciones){
    
    # trayectorias
    trayectoria.tasa.corta.CRC <- trayectoria(u2.CRC, d2.CRC, cant.p)
    trayectoria.tasa.corta.USD <- trayectoria(u2.USD, d2.USD, cant.p)
    
    # tasas cortas
    
    ## Costa Rica
    tasa.corta.CRC <- modelo.ho.lee(u2 = u2.CRC, d2 = d2.CRC, 
                                    curva = curva.CRC, cant.periodos = cant.p, 
                                    trayectoria.tasa.corta = trayectoria.tasa.corta.CRC)
    
    ## Estados Unidos 
    tasa.corta.USD <- modelo.ho.lee(u2 = u2.USD, d2 = d2.USD, 
                                    curva = curva.USD, cant.periodos = cant.p, 
                                    trayectoria.tasa.corta = trayectoria.tasa.corta.USD)    
    
    # mercado de Costa Rica
    
    ## mercado de acciones Costa Rica
    acciones.CRC <- mercado.acciones(u2 = u2.CRC, d2 = d2.CRC, 
                                     u = u.CRC, d = d.CRC, 
                                     curva = curva.CRC, 
                                     cant.periodos = cant.p, 
                                     valor.accion = valor.accion.CRC, 
                                     tasa.corta.CRC)$valor.accion[cant.p + 1] * cant.acciones.CRC

    ## Bonos cero cup贸n de Costa Rica
    bonos.CRC <- valor.bonos(S = S, curva = curva.CRC, 
                             venc = venc.bonos.CRC, valor = valor.bonos.CRC, 
                             u2 = u2.CRC, d2 = d2.CRC, tasa.corta = tasa.corta.CRC)
    
    ## Bonos cuponados de Costa Rica
    bonos.cuponados.CRC <- valor.bonos.cuponados(S = S, curva = curva.CRC, 
                                                 venc = venc.bonos.cuponados.CRC, 
                                                 periodo.cupon = periodo.cupon.CRC, 
                                                 valor = valor.bonos.cuponados.CRC, 
                                                 cupon = cupon.CRC,  
                                                 u2 = u2.CRC, d2 = d2.CRC,
                                                 tasa.corta = tasa.corta.CRC)

    
    # Mercado de Estados Unidos
    
    ## mercado de acciones Estados Unidos
    acciones.USD <- mercado.acciones(u2 = u2.USD, d2 = d2.USD, 
                                     u = u.USD, d = d.USD, 
                                     curva = curva.USD, cant.periodos = cant.p, 
                                     valor.accion = valor.accion.USD, 
                                     tasa.corta = tasa.corta.USD)$valor.accion[cant.p + 1] * cant.acciones.USD
    
    ## Bonos cero cup贸n de Estados Unidos
    bonos.USD <- valor.bonos(S = S, curva = curva.USD, 
                             venc = venc.bonos.USD, valor = valor.bonos.USD, 
                             u2 = u2.USD, d2 = d2.USD, tasa.corta = tasa.corta.USD)
    
    ## Bonos cuponados de Estados Unidos
    bonos.cuponados.USD <- valor.bonos.cuponados(S = S, curva = curva.USD, 
                                                 venc = venc.bonos.cuponados.USD, 
                                                 periodo.cupon = periodo.cupon.USD, 
                                                 valor = valor.bonos.cuponados.USD, 
                                                 cupon = cupon.USD,  
                                                 u2 = u2.USD, d2 = d2.USD, 
                                                 tasa.corta = tasa.corta.USD)
    
    # Valor del portafolio de las acciones, bonos cero cupon y bonos cuponados de Costa Rica
    portafolio.CRC <- acciones.CRC + bonos.CRC + bonos.cuponados.CRC
    
    # Valor del portafolio de las acciones, bonos cero cupon y bonos cuponados de Estados Unidos
    portafolio.USD <- acciones.USD + bonos.USD + bonos.cuponados.USD
    
    # Valor total del portafolio en colones
    portafolio <- portafolio.CRC + portafolio.USD * tipo.cambio.f
    
    # valor total del portafolio en colones asumiendo tipo de cambio fijo
    portafolio.TCF <- portafolio.CRC + portafolio.USD * tipo.cambio

    # se guarda la informaci贸n 
    acciones.CRC.vec[sim] <- acciones.CRC
    bonos.cero.cupon.CRC.vec[sim] <- bonos.CRC
    bonos.cuponados.CRC.vec[sim] <- bonos.cuponados.CRC
    acciones.USD.vec[sim] <- acciones.USD
    bonos.cero.cupon.USD.vec[sim] <- bonos.USD
    bonos.cuponados.USD.vec[sim] <- bonos.cuponados.USD
    portafolio.CRC.vec[sim] <- portafolio.CRC
    portafolio.USD.vec[sim] <- portafolio.USD
    tipo.cambio.forward.vec[sim] <- tipo.cambio.f
    total.portafolio.vec[sim] <- portafolio
    total.portafolio.TCF.vec[sim] <- portafolio.TCF
    Ut.tasa.corta.CRC.vec[sim] <- sum(trayectoria.tasa.corta.CRC)
    Ut.tasa.corta.USD.vec[sim] <- sum(trayectoria.tasa.corta.USD)
    
  }
  return(data.frame(
          simulacion = c(1:cant.simulaciones),
          acciones.CRC = acciones.CRC.vec,
          bonos.cero.cupon.CRC = bonos.cero.cupon.CRC.vec,
          bonos.cuponados.CRC = bonos.cuponados.CRC.vec,
          acciones.USD = acciones.USD.vec,
          bonos.cero.cupon.USD = bonos.cero.cupon.USD.vec,
          bonos.cuponados.USD = bonos.cuponados.USD.vec,
          portafolio.CRC = portafolio.CRC.vec,
          portafolio.USD = portafolio.USD.vec,
          tipo.cambio = tipo.cambio.forward.vec,
          total.portafolio = total.portafolio.vec,
          total.portafolio.TCF = total.portafolio.TCF.vec,
          Ut.tasa.corta.CRC = Ut.tasa.corta.CRC.vec,
          Ut.tasa.corta.USD = Ut.tasa.corta.USD.vec
  ))
}
  
```

```{r}
valor.actual.portafolio <- function(S,
                       curva.CRC, curva.USD, 
                       valor.accion.CRC, cant.acciones.CRC, 
                       valor.accion.USD, cant.acciones.USD,
                       valor.bonos.CRC, venc.bonos.CRC,
                       valor.bonos.USD, venc.bonos.USD,
                       valor.bonos.cuponados.CRC, venc.bonos.cuponados.CRC,
                       periodo.cupon.CRC, cupon.CRC,
                       valor.bonos.cuponados.USD, venc.bonos.cuponados.USD,
                       periodo.cupon.USD, cupon.USD,
                       tipo.cambio){
  
    # mercado de Costa Rica
    
    ## mercado de acciones Costa Rica
    acciones.CRC <- valor.accion.CRC * cant.acciones.CRC
    
    ## Bonos cero cup贸n de Costa Rica
    bonos.CRC <- valor.bonos(S = S, curva = curva.CRC, 
                             venc = venc.bonos.CRC, valor = valor.bonos.CRC)
    
    ## Bonos cuponados de Costa Rica
    bonos.cuponados.CRC <- valor.bonos.cuponados(S = S, curva = curva.CRC, 
                          venc = venc.bonos.cuponados.CRC, 
                          periodo.cupon = periodo.cupon.CRC, 
                          valor = valor.bonos.cuponados.CRC, 
                          cupon = cupon.CRC)

    
    # Mercado de Estados Unidos
    
    ## mercado de acciones Estados Unidos
    acciones.USD <- valor.accion.USD * cant.acciones.USD
    
    ## Bonos cero cup贸n de Estados Unidos
    bonos.USD <- valor.bonos(S = S, curva = curva.USD, 
                             venc = venc.bonos.USD, valor = valor.bonos.USD)
    
    ## Bonos cuponados de Estados Unidos
    bonos.cuponados.USD <- valor.bonos.cuponados(S = S, curva = curva.USD, 
                          venc = venc.bonos.cuponados.USD, 
                          periodo.cupon = periodo.cupon.USD, 
                          valor = valor.bonos.cuponados.USD, 
                          cupon = cupon.USD)
    
    # Valor del portafolio de las acciones, bonos cero cupon y bonos cuponados de Costa Rica
    portafolio.CRC <- acciones.CRC + bonos.CRC + bonos.cuponados.CRC
    
    # Valor del portafolio de las acciones, bonos cero cupon y bonos cuponados de Estados Unidos
    portafolio.USD <- acciones.USD + bonos.USD + bonos.cuponados.USD
    
    # Valor total del portafolio en colones
    portafolio <- portafolio.CRC + portafolio.USD * tipo.cambio
    
    resultados <- data.frame(
      acciones.CRC = acciones.CRC,
      bonos.cero.cupon.CRC = bonos.CRC,
      bonos.cuponados.CRC = bonos.cuponados.CRC,
      acciones.USD = acciones.USD,
      bonos.cero.cupon.USD = bonos.USD,
      bonos.cuponados.USD = bonos.cuponados.USD,
      portafolio.CRC = portafolio.CRC,
      portafolio.USD = portafolio.USD,
      tipo.cambio = tipo.cambio,
      total.portafolio = portafolio
    )
  return(resultados)
}
```

## Cox Ross Rubinstein

```{r}
pan <- read_excel("../data/pan.xlsx")

pai <- read_excel("../data/pai.xlsx")

precpan <- as.numeric(pan$Precio)

precpai <- as.numeric(pai$`Close Price`)

```

### Hallar par谩metros bajo CRR

```{r}
rendpan.log <- diff(log(precpan))
rendpai.log <- diff(log(precpai))

sigma.mensualpan <- sd(rendpan.log)
sigmapan <- sigma.mensualpan * sqrt(12)

sigma.mensualpai <- sd(rendpai.log)
sigmapai <- sigma.mensualpai * sqrt(12)

delta.t <- 1/12

upan <- exp(sigmapan * sqrt(delta.t))
dpan <- exp(-sigmapan * sqrt(delta.t))
upai <- exp(sigmapai * sqrt(delta.t))
dpai <- exp(-sigmapai * sqrt(delta.t))
dpai
```

## Ajustar distribuciones

```{r}
ajustar.distribucion <- function(
    x,
    distribuciones = c("lnorm", "weibull", "norm"),
    criterio = c("AIC","BIC"))
  {
  criterio <- match.arg(criterio)
  
  x <- x[is.finite(x) & x > 0]
  if(length(x) < 10) stop("Muy pocos datos para ajustar distribuciones.")
  
  fits <- list()
  for(d in distribuciones){
    fit <- tryCatch(
      suppressWarnings(fitdistrplus::fitdist(x, d)),
      error = function(e) NULL
    )
    if(!is.null(fit) && all(is.finite(fit$estimate))) fits[[d]] <- fit
  }
  if(length(fits) == 0) stop("Ninguna distribuci贸n pudo ajustarse.")
  
  tabla <- do.call(rbind, lapply(names(fits), function(d){
    fit <- fits[[d]]
    data.frame(Distribucion = d, AIC = AIC(fit), BIC = BIC(fit))
  }))
  
  mejor <- tabla$Distribucion[which.min(tabla[[criterio]])]
  
  list(metricas = tabla, mejor = mejor, fits = fits)
}
```

## Gr谩fico de la distribuci贸n

```{r}
graficar.ajuste <- function(
  x,
  distribucion = c("lnorm", "weibull", "norm"),
  titulo = "Ajuste de distribuci贸n",
  horizonte = NULL
){
  distribucion <- match.arg(distribucion)
  
  # Limpieza
  x <- x[is.finite(x) & x > 0]
  if(length(x) < 10){
    stop("Muy pocos datos para graficar.")
  }
  
  #  Mapeo correcto para MASS::fitdistr
  dist_mass <- switch(
    distribucion,
    lnorm   = "lognormal",
    norm    = "normal",
    weibull = "weibull"
  )
  
  # Ajuste MLE
  fit <- MASS::fitdistr(x, dist_mass)
  est <- fit$estimate
  
  # Media, desviaci贸n y densidad
  if(distribucion == "lnorm"){
    media <- exp(est["meanlog"] + est["sdlog"]^2 / 2)
    desv  <- sqrt((exp(est["sdlog"]^2) - 1) * exp(2*est["meanlog"] + est["sdlog"]^2))
    dens_fun  <- dlnorm
    dens_args <- list(meanlog = est["meanlog"], sdlog = est["sdlog"])
    
  } else if(distribucion == "weibull"){
    media <- est["scale"] * gamma(1 + 1 / est["shape"])
    desv  <- sqrt(est["scale"]^2 *
                   (gamma(1 + 2/est["shape"]) -
                    gamma(1 + 1/est["shape"])^2))
    dens_fun  <- dweibull
    dens_args <- list(shape = est["shape"], scale = est["scale"])
    
  } else if(distribucion == "norm"){
    media <- est["mean"]
    desv  <- est["sd"]
    dens_fun  <- dnorm
    dens_args <- list(mean = est["mean"], sd = est["sd"])
  }
  
  subtitulo <- paste0(
    if(!is.null(horizonte)) paste0("Horizonte: ", horizonte, " a帽os | ") else "",
    "Media = ", round(media / 1e6, 2), " M",
    " | Desv.Est = ", round(desv / 1e6, 2), " M"
  )
  
  ggplot(tibble(x = x), aes(x = x)) +
    geom_histogram(
      aes(y = after_stat(density)),
      bins = nclass.FD(x),
      fill = "#4E79A7",
      color = "white",
      alpha = 0.85
    ) +
    stat_function(
      fun = dens_fun,
      args = dens_args,
      linewidth = 1.5,
      color = "#E15759"
    ) +
    scale_x_continuous(
      labels = label_number(scale = 1e-6, suffix = " M")
    ) +
    labs(
      title = titulo,
      subtitle = subtitulo,
      x = "Valor del portafolio (millones)",
      y = "Densidad"
    ) +
    theme_minimal(base_size = 10) +
    theme(
      plot.title = element_text(face = "bold"),
      panel.grid.minor = element_blank()
    )
}


```

## Estadisticas

```{r}
estadisticas.riesgo <- function(
  x,
  distribucion = c("lnorm", "norm", "weibull"),
  alphas = c(0.05, 0.70),
  escala.millones = TRUE
){
  distribucion <- match.arg(distribucion)
  
  # limpieza
  x <- x[is.finite(x)]
  if(distribucion %in% c("lnorm", "weibull")){
    x <- x[x > 0]
  }
  if(length(x) < 10){
    stop("Muy pocos datos para calcular estad铆sticas.")
  }
  
  # ajuste MLE 
  dist_mass <- switch(
    distribucion,
    lnorm   = "lognormal",
    norm    = "normal",
    weibull = "weibull"
  )
  
  fit <- MASS::fitdistr(x, dist_mass)
  est <- fit$estimate
  
  # funciones VaR / CVaR
  resultados <- lapply(alphas, function(alpha){
    
    if(distribucion == "lnorm"){
      q <- qlnorm(alpha, est["meanlog"], est["sdlog"])
      EX <- exp(est["meanlog"] + 0.5 * est["sdlog"]^2)
      z  <- (log(q) - est["meanlog"] - est["sdlog"]^2) / est["sdlog"]
      cvar <- EX * pnorm(z) / alpha
      
    } else if(distribucion == "norm"){
      q <- qnorm(alpha, est["mean"], est["sd"])
      cvar <- est["mean"] - est["sd"] * dnorm(qnorm(alpha)) / alpha
      
    } else if(distribucion == "weibull"){
      q <- qweibull(alpha, est["shape"], est["scale"])
      # CVaR Weibull (cola izquierda)
      cvar <- est["scale"] * gamma(1 + 1 / est["shape"]) *
              pgamma((q / est["scale"])^est["shape"],
                     shape = 1 + 1 / est["shape"]) / alpha
    }
    
    c(VaR = q, CVaR = cvar)
  })
  
  tabla <- do.call(rbind, resultados)
  rownames(tabla) <- paste0("alpha = ", alphas)
  
  if(escala.millones){
    tabla <- tabla / 1e6
  }
  
  colnames(tabla) <- c("VaR", "CVaR")
  
  round(tabla, 3)
}

```

# Secci贸n 1

```{r}
h7 <- read.csv("../resultados/valor_portafolio_h7.csv", sep = ",")

head(h7)
```


```{r}

# Extrae la curva cero cupon (rhos) para Costa Rica y Estados Unidos
CCC <- read.csv("../data/Curvas Cero Cup贸n.csv", sep = ";")

# Curva de Precios bono cero cupon de Costa Rica
CCC.colones <- CCC %>%
  mutate(
    precio = 1 / (1 + Curva.Cero.Cup贸n.BCCR..Colones. / 100) ^ vencimiento
  ) %>%
  dplyr::select(vencimiento, precio)

# Curva de Precios bono cero cupon de Estados Unidos
CCC.dolares <- CCC %>%
  mutate(
    precio = 1 / (1 + Curva.Cero.Cup贸n.FED..D贸lares. / 100) ^ vencimiento
    ) %>% 
  dplyr::select(vencimiento, precio)
```

## Valor del portafolio en \$t=0\$

```{r}
portafolio <- valor.actual.portafolio(S = 0, curva.CRC = CCC.colones, curva.USD = CCC.dolares, 
                       valor.accion.CRC = 23000, cant.acciones.CRC = 600, 
                       valor.accion.USD = 135, cant.acciones.USD = 400,
                       valor.bonos.CRC = 12000000, venc.bonos.CRC = c(3, 8, 15, 20),
                       valor.bonos.USD = 14500, venc.bonos.USD = c(5, 10, 16),
                       valor.bonos.cuponados.CRC = 21000000, venc.bonos.cuponados.CRC = c(10, 12, 15, 18),
                       periodo.cupon.CRC = c(2, 3, 4, 12), cupon.CRC = c(0.04, 0.06, 0.07, 0.09),
                       valor.bonos.cuponados.USD = 30000, venc.bonos.cuponados.USD = c(17),
                       periodo.cupon.USD = c(12), cupon.USD = c(0.06),
                       tipo.cambio = 498.19)

write.csv(
  portafolio,
  file = "../Resultados/valor_actual_portafolio.csv",
  row.names = FALSE
)

head(portafolio)
```


## Valor del portafolio en $t=4$

```{r}
portafolio.h4 <- montecarlo(S = 4, u2.CRC = 1.0003, d2.CRC = 0.9997, u.CRC = 1.061934, d.CRC = 0.9416777,
                       u2.USD = 1.00005, d2.USD = 0.99995, u.USD = 1.043396, d.USD = 0.9584087,
                       curva.CRC = CCC.colones, curva.USD = CCC.dolares, 
                       valor.accion.CRC = 23000, cant.acciones.CRC = 600, 
                       valor.accion.USD = 135, cant.acciones.USD = 400,
                       valor.bonos.CRC = 12000000, venc.bonos.CRC = c(3, 8, 15, 20),
                       valor.bonos.USD = 14500, venc.bonos.USD = c(5, 10, 16),
                       valor.bonos.cuponados.CRC = 21000000, venc.bonos.cuponados.CRC = c(10, 12, 15, 18),
                       periodo.cupon.CRC = c(2, 3, 4, 12), cupon.CRC = c(0.04, 0.06, 0.07, 0.09),
                       valor.bonos.cuponados.USD = 30000, venc.bonos.cuponados.USD = c(17),
                       periodo.cupon.USD = c(12), cupon.USD = c(0.06),
                       tipo.cambio = 498.19,
                       cant.simulaciones = 10000)

write.csv(
  portafolio.h4,
  file = "../Resultados/valor_portafolio_h4.csv",
  row.names = FALSE
)

head(portafolio.h4)
```

### Ajustar distribuci贸n del portafolio en el horizonte 4

```{r, message=FALSE, warning=FALSE}
h4 <- portafolio.h4$total.portafolio

res.h4 <- ajustar.distribucion(h4, criterio = "AIC")

grafica.h4 <- graficar.ajuste(
  x = h4,
  distribucion = res.h4$mejor,
  titulo = paste0("Portafolio en horizonte de 4 a帽os con ajuste ", res.h4$mejor),
  horizonte = 4
)

res.h4
grafica.h4

ggsave(
  filename = "../Resultados/portafolio_h4_lognormal.jpg",
  plot = grafica.h4,
  width = 8,
  height = 5,
  units = "in",
  dpi = 300
)
```

### Estad铆sticas de riesgo

```{r}
estadisticas.riesgo(
  x = h4,
  distribucion = c("lnorm"),
  alphas = c(0.05, 0.70),
  escala.millones = TRUE
)
```

## Valor del portafolio en $t=7$

```{r}
portafolio.h7 <- montecarlo(S = 7, u2.CRC = 1.0003, d2.CRC = 0.9997, u.CRC = 1.061934, d.CRC = 0.9416777,
                       u2.USD = 1.00005, d2.USD = 0.99995, u.USD = 1.043396, d.USD = 0.9584087,
                       curva.CRC = CCC.colones, curva.USD = CCC.dolares, 
                       valor.accion.CRC = 23000, cant.acciones.CRC = 600, 
                       valor.accion.USD = 135, cant.acciones.USD = 400,
                       valor.bonos.CRC = 12000000, venc.bonos.CRC = c(3, 8, 15, 20),
                       valor.bonos.USD = 14500, venc.bonos.USD = c(5, 10, 16),
                       valor.bonos.cuponados.CRC = 21000000, venc.bonos.cuponados.CRC = c(10, 12, 15, 18),
                       periodo.cupon.CRC = c(2, 3, 4, 12), cupon.CRC = c(0.04, 0.06, 0.07, 0.09),
                       valor.bonos.cuponados.USD = 30000, venc.bonos.cuponados.USD = c(17),
                       periodo.cupon.USD = c(12), cupon.USD = c(0.06),
                       tipo.cambio = 498.19,
                       cant.simulaciones = 10000)

write.csv(
  portafolio.h7,
  file = "../Resultados/valor_portafolio_h7.csv",
  row.names = FALSE
)

head(portafolio.h7)
```

### Ajustar distribuci贸n del portafolio en el horizonte 7

```{r, message=FALSE, warning=FALSE}
h7 <- portafolio.h7$total.portafolio

res.h7 <- ajustar.distribucion(h7, criterio = "AIC")

grafica.h7 <- graficar.ajuste(
  x = h7,
  distribucion = res.h7$mejor,
  titulo = paste0("Portafolio en horizonte de 7 a帽os con ajuste ", res.h7$mejor),
  horizonte = 7
)

res.h7

grafica.h7

ggsave(
  filename = "../Resultados/portafolio_h7_lognormal.jpg",
  plot = grafica.h7,
  width = 8,
  height = 5,
  units = "in",
  dpi = 300
)
```

### Estad铆sticas de riesgo

```{r}
estadisticas.riesgo(
  x = h7,
  distribucion = c("lnorm"),
  alphas = c(0.05, 0.70),
  escala.millones = TRUE
)
```

## Valor del portafolio en $t=10$

```{r, message=FALSE, warning=FALSE}
portafolio.h10 <- montecarlo(S = 10, u2.CRC = 1.0003, d2.CRC = 0.9997, u.CRC = 1.061934, d.CRC = 0.9416777,
                       u2.USD = 1.00005, d2.USD = 0.99995, u.USD = 1.043396, d.USD = 0.9584087,
                       curva.CRC = CCC.colones, curva.USD = CCC.dolares, 
                       valor.accion.CRC = 23000, cant.acciones.CRC = 600, 
                       valor.accion.USD = 135, cant.acciones.USD = 400,
                       valor.bonos.CRC = 12000000, venc.bonos.CRC = c(3, 8, 15, 20),
                       valor.bonos.USD = 14500, venc.bonos.USD = c(5, 10, 16),
                       valor.bonos.cuponados.CRC = 21000000, venc.bonos.cuponados.CRC = c(10, 12, 15, 18),
                       periodo.cupon.CRC = c(2, 3, 4, 12), cupon.CRC = c(0.04, 0.06, 0.07, 0.09),
                       valor.bonos.cuponados.USD = 30000, venc.bonos.cuponados.USD = c(17),
                       periodo.cupon.USD = c(12), cupon.USD = c(0.06),
                       tipo.cambio = 498.19,
                       cant.simulaciones = 10000)

write.csv(
  portafolio.h10,
  file = "../Resultados/valor_portafolio_h10.csv",
  row.names = FALSE
)

head(portafolio.h10)
```

### Ajustar distribuci贸n del portafolio en el horizonte 10

```{r, message=FALSE, warning=FALSE}
h10 <- portafolio.h10$total.portafolio

res.h10 <- ajustar.distribucion(h10, criterio = "AIC")

grafica.h10 <- graficar.ajuste(
  x = h10,
  distribucion = res.h10$mejor,
  titulo = paste0("Portafolio en horizonte de 10 a帽os con ajuste ", res.h10$mejor),
  horizonte = 10
)

res.h10

grafica.h10

ggsave(
  filename = "../Resultados/portafolio_h10_lognormal.jpg",
  plot = grafica.h10,
  width = 8,
  height = 5,
  units = "in",
  dpi = 300
)
```

### Estad铆sticas de riesgo

```{r}
estadisticas.riesgo(
  x = h10,
  distribucion = c("lnorm"),
  alphas = c(0.05, 0.70),
  escala.millones = TRUE
)
```

## Valor del portafolio en $t=15$

```{r}
portafolio.h15 <- montecarlo(S = 15, u2.CRC = 1.0003, d2.CRC = 0.9997, u.CRC = 1.061934, d.CRC = 0.9416777,
                       u2.USD = 1.00005, d2.USD = 0.99995, u.USD = 1.043396, d.USD = 0.9584087,
                       curva.CRC = CCC.colones, curva.USD = CCC.dolares, 
                       valor.accion.CRC = 23000, cant.acciones.CRC = 600, 
                       valor.accion.USD = 135, cant.acciones.USD = 400,
                       valor.bonos.CRC = 12000000, venc.bonos.CRC = c(3, 8, 15, 20),
                       valor.bonos.USD = 14500, venc.bonos.USD = c(5, 10, 16),
                       valor.bonos.cuponados.CRC = 21000000, venc.bonos.cuponados.CRC = c(10, 12, 15, 18),
                       periodo.cupon.CRC = c(2, 3, 4, 12), cupon.CRC = c(0.04, 0.06, 0.07, 0.09),
                       valor.bonos.cuponados.USD = 30000, venc.bonos.cuponados.USD = c(17),
                       periodo.cupon.USD = c(12), cupon.USD = c(0.06),
                       tipo.cambio = 498.19,
                       cant.simulaciones = 10000)

write.csv(
  portafolio.h15,
  file = "../Resultados/valor_portafolio_h15.csv",
  row.names = FALSE
)

head(portafolio.h15)
```

### Ajustar distribuci贸n del portafolio en el horizonte 15

```{r, message=FALSE, warning=FALSE}
h15 <- portafolio.h15$total.portafolio

res.h15 <- ajustar.distribucion(h15, criterio = "AIC")

grafica.h15 <- graficar.ajuste(
  x = h15,
  distribucion = res.h15$mejor,
  titulo = paste0("Portafolio en horizonte de 15 a帽os con ajuste ", res.h15$mejor),
  horizonte = 15
)

grafica.h15

ggsave(
  filename = "../Resultados/portafolio_h15_lognormal.jpg",
  plot = grafica.h15,
  width = 8,
  height = 5,
  units = "in",
  dpi = 300
)
```

### Estad铆sticas de riesgo

```{r}
estadisticas.riesgo(
  x = h15,
  distribucion = c("lnorm"),
  alphas = c(0.05, 0.70),
  escala.millones = TRUE
)
```


# Secci贸n 2

```{r}

valorar.compra.acciones <- function(S, u2, d2, u, d, 
                                    curva, valor.accion, cant.acciones.nuevas,
                                    Kf, cant.simulaciones){

  cant.p <- as.integer(ceiling(S * 12))
  K <- max(Kf - 5000, 0)
  
  # vectores para guardar los valores de las simulaciones
  acciones.vec <- numeric(cant.simulaciones)
  compra.directa.vec <- numeric(cant.simulaciones)
  call.europea.vec <- numeric(cant.simulaciones)

  for(sim in 1:cant.simulaciones){
    
    # trayectoria
    trayectoria.tasa.corta <- trayectoria(u2, d2, cant.p)

    # tasa corta
    tasa.corta <- modelo.ho.lee(u2, d2, curva, cant.p, trayectoria.tasa.corta)

    # mercado de acciones
    acciones <- mercado.acciones(
      u2 = u2, d2 = d2,
      u = u, d = d,
      curva = curva,
      cant.periodos = cant.p,
      valor.accion = valor.accion,
      tasa.corta = tasa.corta
    )$valor.accion[cant.p + 1]

    # Compra de acciones directa (independiente al valor que tome la accion)
    compra.directa <- cant.acciones.nuevas * acciones
    
    # Compra de acciones mediante una opcion call (depende del valor que tome la accion en ese momento y el strike) 
    call.europea <- cant.acciones.nuevas * pmax(acciones - K, 0)

    # se guarda la informaci贸n
    acciones.vec[sim] <- acciones
    compra.directa.vec[sim] <- compra.directa
    call.europea.vec[sim] <- call.europea
  }

  return(data.frame(
    simulacion = 1:cant.simulaciones,
    acciones = acciones.vec,
    compra.directa = compra.directa.vec,
    call.europea = call.europea.vec
  ))
}

```

```{r}

Kf <- 23000 * exp(15 * 12 * 0.0035)

nuevas.acciones <- valorar.compra.acciones(S = 15, u2 = 1.0003, d2 = 0.9997, 
                                           u = 1.061934, d = 0.9416777,
                                           curva = CCC.colones, valor.accion = 23000, 
                                           cant.acciones.nuevas = 300, Kf = Kf, cant.simulaciones = 10000)
write.csv(
  nuevas.acciones,
  file = "../Resultados/nuevas_acciones.csv",
  row.names = FALSE
)

head(nuevas.acciones)
```

## Resultados

### V铆a compra directa

```{r}

compra.directa <- nuevas.acciones$compra.directa
portafolio.cd  <- compra.directa + h15

cat("Compra Directa \n")
cat("Valor esperado compra directa:", round(mean(compra.directa), 2), "\n")
cat("Desviaci贸n est谩ndar compra directa:", round(sd(compra.directa), 2), "\n\n")

cat("Portafolio total (acciones nuevas + lo que ya estaba):\n")
cat("Valor esperado:", round(mean(portafolio.cd), 2), "\n")
cat("Desviaci贸n est谩ndar:", round(sd(portafolio.cd), 2), "\n")
cat("Mediana:", round(median(portafolio.cd), 2), "\n")
```

### V铆a Opciones Call-Europea

```{r}

call.europea <- nuevas.acciones$call.europea
portafolio.call <- call.europea + h15

cat("Opci贸n Call Europea \n")
cat("Valor esperado:", round(mean(call.europea), 2), "\n")
cat("Desviaci贸n est谩ndar:", round(sd(call.europea), 2), "\n\n")

cat("Portafolio total (call + lo que ya estaba):\n")
cat("Valor esperado:", round(mean(portafolio.call), 2), "\n")
cat("Desviaci贸n est谩ndar:", round(sd(portafolio.call), 2), "\n")
cat("Mediana:", round(median(portafolio.call), 2), "\n")
```

```{r}
cat("Comparaci贸n \n")
cat("Reducci贸n de volatilidad (Call vs Compra Directa):",
    round(sd(portafolio.cd) - sd(portafolio.call), 2), "\n")
```

